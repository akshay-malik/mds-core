suite: test cronjob metrics sheet
templates:
  - cronjob.yaml
tests:
  - it: all
    release:
      namespace: mds
    set:
      audience: audience-stub
      auth0Domain: auth0Domain-stub
      clientId: clientId-stub
      googleClientEmail: googleClientEmail-stub
      clientSecret: clientSecret-stub
      googlePrivateKey: googlePrivateKey-stub
    asserts:
      - hasDocuments:
          count: 2
      - isAPIVersion:
          of: batch/v1beta1
      - isKind:
          of: CronJob
      - equal:
          path: metadata.name
          value: metrics-sheet
      - equal:
          path: metadata.namespace
          value: mds
      - equal:
          path: spec.schedule
          value: |-
            */1 * * * *
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].name
          value: metrics-sheet
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: busybox
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[0].name
          value: AUDIENCE
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[0].value
          value: audience-stub
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[1].name
          value: AUTH0_DOMAIN
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[1].value
          value: auth0Domain-stub
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[2].name
          value: CLIENT_ID
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[2].value
          value: clientId-stub
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[3].name
          value: CLIENT_SECRET
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: CLIENT_SECRET
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: metrics-sheet
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[4].name
          value: GOOGLE_CLIENT_EMAIL
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[4].value
          value: googleClientEmail-stub
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[5].name
          value: GOOGLE_PRIVATE_KEY
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.key
          value: GOOGLE_PRIVATE_KEY
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.name
          value: metrics-sheet
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].restartPolicy
          value: OnFailure
      - isAPIVersion:
          of: v1
        documentIndex: 1
      - isKind:
          of: Secret
        documentIndex: 1
      - equal:
          path: metadata.name
          value: metrics-sheet
        documentIndex: 1
      - equal:
          path: metadata.namespace
          value: mds
        documentIndex: 1
      - equal:
          path: type
          value: Opaque
        documentIndex: 1
      - equal:
          path: data.CLIENT_SECRET
          value: Y2xpZW50U2VjcmV0LXN0dWI=
        documentIndex: 1
      - equal:
          path: data.GOOGLE_PRIVATE_KEY
          value: Z29vZ2xlUHJpdmF0ZUtleS1zdHVi
        documentIndex: 1